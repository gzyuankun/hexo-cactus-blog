<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5" />
    <meta name="description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件">
<meta property="og:type" content="article">
<meta property="og:title" content="网络文件共享服务">
<meta property="og:url" content="http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/index.html">
<meta property="og:site_name" content="Dreams">
<meta property="og:description" content="Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://cactus.itshare.work/image.assets/1670127215657.png">
<meta property="og:image" content="http://cactus.itshare.work/image.assets/1670127252975.png">
<meta property="og:image" content="http://cactus.itshare.work/image.assets/1670246134779.png">
<meta property="og:image" content="http://cactus.itshare.work/image.assets/1670396738139.png">
<meta property="og:image" content="http://cactus.itshare.work/image.assets/1670403695085.png">
<meta property="article:published_time" content="2022-12-04T04:03:44.000Z">
<meta property="article:modified_time" content="2023-03-03T10:14:50.260Z">
<meta property="article:author" content="yuan kun">
<meta property="article:tag" content="Linux从入门到放弃">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://cactus.itshare.work/image.assets/1670127215657.png">
    
    
      
        
          <link rel="shortcut icon" href="/images/favicon.ico">
        
      
      
        
          <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
        
      
      
        
          <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
        
      
    
    <!-- title -->
    <title>网络文件共享服务</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
    <!-- rss -->
    
    
	<!-- mathjax -->
	
<meta name="generator" content="Hexo 6.3.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#" aria-label="目录"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" aria-label="顶部" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     -->
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" aria-label="上一篇" href="/2022/12/07/Redis%E9%83%A8%E7%BD%B2%E5%92%8C%E5%9F%BA%E7%A1%80%E4%BD%BF%E7%94%A8/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" aria-label="下一篇" href="/2022/12/03/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" aria-label="返回顶部" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" aria-label="分享文章" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">上一篇</span>
      <span id="i-next" class="info" style="display:none;">下一篇</span>
      <span id="i-top" class="info" style="display:none;">返回顶部</span>
      <span id="i-share" class="info" style="display:none;">分享文章</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&text=网络文件共享服务"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&is_video=false&description=网络文件共享服务"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=网络文件共享服务&body=Check out this article: http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&name=网络文件共享服务&description=Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&t=网络文件共享服务"><i class="fab fa-hacker-news " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NFS%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">NFS服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">NFS工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E8%BD%AF%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">NFS软件介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.</span> <span class="toc-text">NFS工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rpcinfo"><span class="toc-number">1.3.1.</span> <span class="toc-text">rpcinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exportfs"><span class="toc-number">1.3.2.</span> <span class="toc-text">exportfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#showmount"><span class="toc-number">1.3.3.</span> <span class="toc-text">showmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mount-nfs"><span class="toc-number">1.3.4.</span> <span class="toc-text">mount.nfs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">实战案例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text">数据的实时同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.0.1.</span> <span class="toc-text">实时同步技术介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-inotify"><span class="toc-number">3.0.2.</span> <span class="toc-text">实现 inotify</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#inotify-tools%E5%B7%A5%E5%85%B7"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">inotify-tools工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">rsync 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync%E5%91%BD%E4%BB%A4"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">rsync命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inotify-rsync-shell-%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">3.1.1.</span> <span class="toc-text">inotify+rsync+shell 脚本实现实时数据同步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sersync-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">3.2.</span> <span class="toc-text">sersync 实现实时数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sersync-%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">sersync 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ersync-daemon-%E5%AE%9E%E7%8E%B0-sersync"><span class="toc-number">3.2.2.</span> <span class="toc-text">基于rsync daemon 实现 sersync</span></a></li></ol></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        网络文件共享服务
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">yuan kun</span>
      </span>
      
    <div class="postdate">
      
        <time datetime="2022-12-04T04:03:44.000Z" itemprop="datePublished">2022-12-04</time>
        
      
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/Linux%E5%9F%BA%E7%A1%80/">Linux基础</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link-link" href="/tags/Linux%E4%BB%8E%E5%85%A5%E9%97%A8%E5%88%B0%E6%94%BE%E5%BC%83/" rel="tag">Linux从入门到放弃</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="NFS服务"><a href="#NFS服务" class="headerlink" title="NFS服务"></a>NFS服务</h1><h2 id="NFS工作原理"><a href="#NFS工作原理" class="headerlink" title="NFS工作原理"></a>NFS工作原理</h2><p><img src="/../image.assets/1670127215657.png" alt="1670127215657"></p>
<p>NFS：Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件，基于RPC（Remote Procedure CallProtocol 远程过程调用）实现。<br>RPC采用C&#x2F;S模式，客户机请求程序调用进程发送一个有进程参数的调用信息到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信息，获得进程结果，然后调用执行继续进行。</p>
<p><img src="/../image.assets/1670127252975.png" alt="1670127252975"></p>
<p>NFS优势：节省本地存储空间，将常用的数据,如：&#x2F;home目录，存放在NFS服务器上且可以通过网络访<br>问，本地终端将可减少自身存储空间的使用。</p>
<h2 id="NFS软件介绍"><a href="#NFS软件介绍" class="headerlink" title="NFS软件介绍"></a>NFS软件介绍</h2><p>软件包：nfs-utils（包括服务器和客户端相关工具，CentOS8 最小化安装时默认没有安装），nfs-common(Ubuntu中包名)<br>相关软件包：rpcbind（必须），tcp_wrappers<br>Kernel支持：nfs.ko<br>端口：2049(nfsd), 其它端口由portmap(111)分配<br>NFS服务主要进程：  </p>
<ul>
<li>rpc.nfsd 最主要的NFS进程，管理客户端是否可登录  </li>
<li>rpc.mountd 挂载和卸载NFS文件系统，包括权限管理  </li>
<li>rpc.lockd 非必要，管理文件锁，避免同时写出错  </li>
<li>rpc.statd 非必要，检查文件一致性，可修复文件</li>
</ul>
<p>说明：CentOS 6 开始portmap进程由rpcbind代替<br>日志：&#x2F;var&#x2F;lib&#x2F;nfs&#x2F;<br>NFS配置文件</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/etc/exports</span><br><span class="line">/etc/exports.d/*.exports</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">默认选项：(ro,sync,root_squash,no_all_squash)</span><br><span class="line">ro,rw 只读和读写</span><br><span class="line">async 异步，数据变化后不立即写磁盘，先写入到缓冲区中，过一段时间再写入磁盘，性能高,安全性低</span><br><span class="line">sync（1.0.0后为默认）同步，数据在请求时立即写入共享存储磁盘,性能低,安全性高</span><br><span class="line">root_squash （默认）远程root映射为nfsnobody,UID为65534，CentOS8 为nobody,CentOS</span><br><span class="line">7以前的版本为nfsnobody</span><br><span class="line">no_root_squash 远程root映射成NFS服务器的root用户</span><br><span class="line">all_squash 所有远程用户(包括root)都变成nfsnobody,CentOS8 为nobody</span><br><span class="line">no_all_squash （默认）保留共享文件的UID和GID</span><br><span class="line">anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非nobody,可配合all_squash使</span><br><span class="line">用</span><br></pre></td></tr></table></figure>

<h2 id="NFS工具"><a href="#NFS工具" class="headerlink" title="NFS工具"></a>NFS工具</h2><h3 id="rpcinfo"><a href="#rpcinfo" class="headerlink" title="rpcinfo"></a>rpcinfo</h3><p>rpcinfo 工具可以查看RPC相关信息<br>查看注册在指定主机的RPC程序</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpcinfo -p hostname</span><br></pre></td></tr></table></figure>

<p>查看RPC注册程序</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpcinfo -s hostname</span><br></pre></td></tr></table></figure>

<h3 id="exportfs"><a href="#exportfs" class="headerlink" title="exportfs"></a>exportfs</h3><p>exportfs:可用于管理NFS导出的文件系统<br>常见选项</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-v #查看本机所有NFS共享</span><br><span class="line">-r #重读配置文件，并共享目录</span><br><span class="line">-a #输出本机所有共享</span><br><span class="line">-au #停止本机所有共享</span><br></pre></td></tr></table></figure>

<h3 id="showmount"><a href="#showmount" class="headerlink" title="showmount"></a>showmount</h3><p>常见用法：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#查看远程主机的NFS共享</span><br><span class="line">showmount -e hostname</span><br></pre></td></tr></table></figure>

<h3 id="mount-nfs"><a href="#mount-nfs" class="headerlink" title="mount.nfs"></a>mount.nfs</h3><p>客户端NFS挂载<br>NFS相关的挂载选项：man 5 nfs</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">fg #（默认）前台挂载</span><br><span class="line">bg #后台挂载</span><br><span class="line">hard #（默认）持续请求</span><br><span class="line">soft #非持续请求</span><br><span class="line">intr #和hard配合，请求可中断</span><br><span class="line">rsize #和wsize 一次读和写数据最大字节数，rsize=32768</span><br><span class="line">_netdev #无网络服务时不挂载NFS资源</span><br><span class="line">vers #指定版本，客户端centos8默认4.2 ，centos7默认4.1 centos6默认4.0</span><br></pre></td></tr></table></figure>

<p>提示：基于安全考虑，建议使用 nosuid,<em>netdev,noexec 挂载选项</em></p>
<h1 id="实战案例"><a href="#实战案例" class="headerlink" title="实战案例"></a>实战案例</h1><p><img src="/../image.assets/1670246134779.png" alt="1670246134779"></p>
<ul>
<li>NFS服务器安装软件</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"># 启动rpcbind</span><br><span class="line">systemctl start rpcbind</span><br><span class="line"></span><br><span class="line"># 启动nfs-server</span><br><span class="line">systemctl start nfs-server</span><br></pre></td></tr></table></figure>

<ul>
<li>NFS服务器创建共享文件</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 共享根目录下的share目录</span><br><span class="line">mkdir /share</span><br></pre></td></tr></table></figure>

<ul>
<li>添加uid和gid为300的用户nfs-upload</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7-master ~]# groupadd -g 300 nfs-upload</span><br><span class="line">[root@centos7-master ~]# useradd -u 300 -g 300 nfs-upload</span><br><span class="line">[root@centos7-master ~]# </span><br><span class="line">#修改所属组权限</span><br><span class="line">[root@centos7-master share]# chown -R 300:300 /share</span><br></pre></td></tr></table></figure>

<ul>
<li>修改NFS服务器配置文件</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7-master ~]# vim /etc/exports</span><br><span class="line"># 加入如下内容，*表示任何人，rw表示读写</span><br><span class="line">/share/ 192.168.179.*(rw,anongid=300,anonuid=300)</span><br></pre></td></tr></table></figure>

<ul>
<li>重新加载配置</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 重新加载配置文件</span><br><span class="line">[root@centos7-master ~]# exportfs -r</span><br><span class="line">[root@centos7-master ~]# exportfs -v</span><br><span class="line">/share        	192.168.179.*(sync,wdelay,hide,no_subtree_check,anonuid=300,anongid=300,sec=sys,rw,secure,root_squash,no_all_squash)</span><br><span class="line">[root@centos7-master ~]# </span><br></pre></td></tr></table></figure>

<ul>
<li>客户端安装软件</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br><span class="line"></span><br><span class="line"># 启动rpcbind</span><br><span class="line">systemctl start rpcbind</span><br><span class="line"></span><br><span class="line"># 启动nfs-server</span><br><span class="line">systemctl start nfs-server</span><br></pre></td></tr></table></figure>

<ul>
<li>添加用户和组</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7-slave /]# groupadd -g 300 nfs-upload</span><br><span class="line">[root@centos7-slave /]# useradd -u 300 -g 300 nfs-upload</span><br></pre></td></tr></table></figure>

<ul>
<li>在客户端挂载，挂载&#x2F;nfsshare目录下</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># 创建目录</span><br><span class="line">mkdir /nfsshare</span><br><span class="line"># 查看服务器端可挂载点</span><br><span class="line">[root@centos7-slave ~]# showmount -e 192.168.179.170</span><br><span class="line">Export list for 192.168.179.170:</span><br><span class="line">/share *</span><br><span class="line">[root@centos7-slave nfsshare]# </span><br><span class="line"></span><br><span class="line"># 挂载方式1，关机重启会失效</span><br><span class="line">[root@centos7-slave ~]# mount 192.168.179.170:/share/ /nfsshare</span><br><span class="line"></span><br><span class="line"># 方式二修改配置文件，关机重启不失效</span><br><span class="line">[root@centos7-slave ~]# vim /etc/fstab </span><br><span class="line"># 加入如下内容</span><br><span class="line">192.168.179.170:/share                    /nfsshare  nfs     defaults,_netdev 0 0</span><br><span class="line"># 使配置文件生效</span><br><span class="line">[root@centos7-slave nfsshare]# mount -a</span><br><span class="line">[root@centos7-slave nfsshare]# </span><br></pre></td></tr></table></figure>

<ul>
<li>测试</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># 在客户端上查看/nfsshare的内容</span><br><span class="line">[root@centos7-slave nfsshare]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx</span><br><span class="line">drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile</span><br><span class="line">-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log</span><br><span class="line">[root@centos7-slave nfsshare]# </span><br><span class="line"></span><br><span class="line"># 在服务器端查看/share目录</span><br><span class="line">[root@centos7-master share]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 nfs-upload nfs-upload  5 Dec  5 23:14 a.xtx</span><br><span class="line">drwxr-xr-x 2 nfs-upload nfs-upload  6 Dec  5 23:17 newfile</span><br><span class="line">-rw-r--r-- 1 nfs-upload nfs-upload 17 Dec  5 23:11 test.log</span><br><span class="line">[root@centos7-master share]#</span><br></pre></td></tr></table></figure>

<h1 id="数据的实时同步"><a href="#数据的实时同步" class="headerlink" title="数据的实时同步"></a>数据的实时同步</h1><h3 id="实时同步技术介绍"><a href="#实时同步技术介绍" class="headerlink" title="实时同步技术介绍"></a>实时同步技术介绍</h3><p>实现实时同步的方法</p>
<ul>
<li>inotify + rsync 方式实现数据同步</li>
<li>sersync ：前金山公司周洋（花椒直播）在 inotify 软件基础上进行开发的，功能更加强大</li>
</ul>
<p>工作原理：</p>
<ul>
<li>要利用监控服务（inotify），监控同步数据服务器目录中信息的变化</li>
<li>发现目录中数据产生变化，就利用rsync服务推送到备份服务器上</li>
</ul>
<p>inotify：<br>异步的文件系统事件监控机制，利用事件驱动机制，而无须通过诸如cron等的轮询机制来获取事件，linux内核从2.6.13起支持 inotify，通过inotify可以监控文件系统中添加、删除，修改、移动等各种事件</p>
<p><strong>实现inotify软件：</strong></p>
<ul>
<li>inotify-tools</li>
<li>sersync</li>
<li>lrsyncd</li>
</ul>
<p><strong>inotify+rsync使用方式</strong></p>
<ul>
<li>inotify 对同步数据目录信息的监控</li>
<li>rsync 完成对数据的同步</li>
<li>利用脚本进行结合</li>
</ul>
<h3 id="实现-inotify"><a href="#实现-inotify" class="headerlink" title="实现 inotify"></a>实现 inotify</h3><p>内核是否支持inotify<br>Linux支持inotify的内核最小版本为 2.6.13，参看man 7 inotify</p>
<p><strong>inotify 内核参数说明：</strong></p>
<ul>
<li>max_queued_events：inotify 事件队列最大长度，如值太小会出现 Event Queue Overflow 错<br>误，默认值：16384, 生产环境建议调大,比如:327679</li>
<li>max_user_instances：每个用户创建inotify实例最大值，默认值：128</li>
<li>max_user_watches：可以监视的文件的总数量（inotifywait 单进程），默认值：8192,建议调大</li>
</ul>
<h4 id="inotify-tools工具"><a href="#inotify-tools工具" class="headerlink" title="inotify-tools工具"></a>inotify-tools工具</h4><p>inotify-tools参考文档：<a target="_blank" rel="noopener" href="https://github.com/rvoicilas/inotify-tools/wiki">https://github.com/rvoicilas/inotify-tools/wiki</a><br>安装inotify-tools：基于epel源</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install epel-release</span><br><span class="line">yum -y install inotify-tools</span><br></pre></td></tr></table></figure>

<p><strong>inotify-tools包主要工具：</strong></p>
<ul>
<li>inotifywait： 在被监控的文件或目录上等待特定文件系统事件（open ，close，delete等）发生，<br>常用于实时同步的目录监控</li>
<li>inotifywatch：收集被监控的文件系统使用的统计数据，指文件系统事件发生的次数统计</li>
</ul>
<p>inotifywait 命令<br>格式:</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">inotifywait [ options ] file1 [ file2 ] [ file3 ] [ ... ]</span><br></pre></td></tr></table></figure>

<p>常用选项</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-m, --monitor 始终保持事件监听</span><br><span class="line">-d, --daemon 以守护进程方式执行，和-m相似，配合-o使用</span><br><span class="line">-r, --recursive 递归监控目录数据信息变化</span><br><span class="line">-q, --quiet 输出少量事件信息</span><br><span class="line">--exclude &lt;pattern&gt; 指定排除文件或目录，使用扩展的正则表达式匹配的模式实现</span><br><span class="line">--excludei &lt;pattern&gt; 和exclude相似，不区分大小写</span><br><span class="line">-o, --outfile &lt;file&gt; 打印事件到文件中，相当于标准正确输出，注意：使用绝对路径</span><br><span class="line">-s, --syslogOutput 发送错误到syslog相当于标准错误输出</span><br><span class="line">--timefmt &lt;fmt&gt; 指定时间输出格式</span><br><span class="line">--format &lt;fmt&gt; 指定的输出格式；即实际监控输出内容</span><br><span class="line">-e</span><br></pre></td></tr></table></figure>

<p><strong>inotifywait 的–timefmt 时间格式</strong><br>参考 man 3 strftime</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">%Y #年份信息，包含世纪信息</span><br><span class="line">%y #年份信息，不包括世纪信息</span><br><span class="line">%m #显示月份，范围 01-12</span><br><span class="line">%d #每月的第几天，范围是 01-31</span><br><span class="line">%H #小时信息，使用 24小时制，范围 00-23</span><br><span class="line">%M #分钟，范围 00-59</span><br><span class="line">%S #秒，范例 0-60</span><br></pre></td></tr></table></figure>

<p>范例：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--timefmt &quot;%Y-%m-%d %H:%M:%S&quot;</span><br></pre></td></tr></table></figure>

<p><strong>inotifywait 的 –format 格式定义</strong></p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%T #输出时间格式中定义的时间格式信息，通过 --timefmt option 语法格式指定时间信息</span><br><span class="line">%w #事件出现时，监控文件或目录的名称信息，相当于dirname</span><br><span class="line">%f #事件出现时，将显示监控目录下触发事件的文件或目录信息，否则为空，相当于basename</span><br><span class="line">%e #显示发生的事件信息，不同的事件默认用逗号分隔</span><br><span class="line">%Xe #显示发生的事件信息，不同的事件指定用X进行分隔</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">--format &quot;%T %w%f event: %;e&quot;</span><br><span class="line">--format &#x27;%T %w %f&#x27;</span><br></pre></td></tr></table></figure>

<p>inotifywait -e 选项指定的事件类型</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">create #文件或目录创建</span><br><span class="line">delete #文件或目录被删除</span><br><span class="line">modify #文件或目录内容被写入</span><br><span class="line">attrib #文件或目录属性改变</span><br><span class="line">close_write #文件或目录关闭，在写入模式打开之后关闭的</span><br><span class="line">close_nowrite #文件或目录关闭，在只读模式打开之后关闭的</span><br><span class="line">close #文件或目录关闭，不管读或是写模式</span><br><span class="line">open #文件或目录被打开</span><br><span class="line">lsdir #浏览目录内容</span><br><span class="line">moved_to #文件或目录被移动到监控的目录中</span><br><span class="line">moved_from #文件或目录从监控的目录中被移动</span><br><span class="line">move #文件或目录不管移动到或是移出监控目录都触发事件</span><br><span class="line">access #文件或目录内容被读取</span><br><span class="line">delete_self #文件或目录被删除，目录本身被删除</span><br><span class="line">unmount #取消挂载</span><br></pre></td></tr></table></figure>

<p>范例</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-e create,delete,moved_to,close_write,attrib</span><br></pre></td></tr></table></figure>

<p>范例：使用inotifywait</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 监控一次事件</span><br><span class="line">[root@centos7 /]# inotifywait /data/www/</span><br><span class="line">Setting up watches.</span><br><span class="line">Watches established.</span><br><span class="line">/data/www/ CREATE,ISDIR html</span><br><span class="line">[root@centos7 /]# </span><br><span class="line"></span><br><span class="line"># 持续前台监控</span><br><span class="line">[root@centos7 /]# inotifywait -mrq /data/www --exclude=&quot;.*\.swx|\.swp&quot;</span><br><span class="line">/data/www/ OPEN,ISDIR </span><br><span class="line">/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR </span><br><span class="line">/data/www/ CREATE mysql.log</span><br><span class="line">/data/www/ OPEN mysql.log</span><br><span class="line">/data/www/ ATTRIB mysql.log</span><br><span class="line">/data/www/ CLOSE_WRITE,CLOSE mysql.log</span><br><span class="line">/data/www/ OPEN,ISDIR </span><br><span class="line">/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR </span><br><span class="line">/data/www/ MODIFY mysql.log</span><br><span class="line">/data/www/ OPEN mysql.log</span><br><span class="line">/data/www/ MODIFY mysql.log</span><br><span class="line">/data/www/ CLOSE_WRITE,CLOSE mysql.log</span><br><span class="line">/data/www/ OPEN,ISDIR </span><br><span class="line">/data/www/ CLOSE_NOWRITE,CLOSE,ISDIR </span><br><span class="line">/data/www/ OPEN mysql.log</span><br><span class="line">/data/www/ ACCESS mysql.log</span><br><span class="line">/data/www/ CLOSE_NOWRITE,CLOSE mysql.log</span><br><span class="line"></span><br><span class="line">#持续后台监控，并记录日志</span><br><span class="line">inotifywait -o /root/inotify.log -drq /data/www --timefmt &quot;%Y-%m-%d %H:%M:%S&quot; --</span><br><span class="line">format &quot;%T %w%f event: %e&quot;</span><br><span class="line">#持续前台监控特定事件</span><br><span class="line">inotifywait -mrq /data/www --timefmt &quot;%F %H:%M:%S&quot; --format &quot;%T %w%f event:</span><br><span class="line">%;e&quot; -e create,delete,moved_to,close_write,attrib</span><br></pre></td></tr></table></figure>

<h2 id="rsync-服务"><a href="#rsync-服务" class="headerlink" title="rsync 服务"></a>rsync 服务</h2><p>rsync 常用于做为 linux系统下的数据镜像备份工具，实现远程同步，支持本地复制，或者与其他SSH、<br>rsync主机同步数据，支持增量备份，配合任务计划，rsync能实现定时或间隔同步，配合inotify或<br>sersync，可以实现触发式的实时数据同步<br>官方网站: <a target="_blank" rel="noopener" href="http://rsync.samba.org/">http://rsync.samba.org/</a></p>
<p>软件包：rsync，rsync-daemon（CentOS 8）<br>服务文件：&#x2F;usr&#x2F;lib&#x2F;systemd&#x2F;system&#x2F;rsyncd.service<br>配置文件：&#x2F;etc&#x2F;rsyncd.conf<br>端口：873&#x2F;tcp</p>
<h4 id="rsync命令"><a href="#rsync命令" class="headerlink" title="rsync命令"></a>rsync命令</h4><p>rsync 格式</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#Local:</span><br><span class="line">rsync [OPTION...] SRC... [DEST]</span><br><span class="line">#Access via remote shell:</span><br><span class="line">Pull:</span><br><span class="line">rsync [OPTION...] [USER@]HOST:SRC... [DEST]</span><br><span class="line">Push:</span><br><span class="line">rsync [OPTION...] SRC... [USER@]HOST:DEST</span><br><span class="line">#Access via rsync daemon:</span><br><span class="line">Pull:</span><br><span class="line">rsync [OPTION...] [USER@]HOST::SRC... [DEST]</span><br><span class="line">rsync [OPTION...] rsync://[USER@]HOST[:PORT]/SRC... [DEST]</span><br><span class="line">Push:</span><br><span class="line">rsync [OPTION...] SRC... [USER@]HOST::DEST</span><br><span class="line">rsync [OPTION...] SRC... rsync://[USER@]HOST[:PORT]/DEST</span><br><span class="line">The &#x27;:&#x27; usages connect via remote shell, while &#x27;::&#x27; &amp; &#x27;rsync://&#x27; usages connect</span><br><span class="line">to an rsync daemon, and require SRC or DEST to start with a module name.</span><br></pre></td></tr></table></figure>

<p>rsync有三种工作方式：</p>
<ol>
<li>本地文件系统上实现同步。命令行语法格式为上述”Local”段的格式。</li>
<li>本地主机使用远程shell和远程主机通信。命令行语法格式为上述”Access via remote shell”段的格<br>式。</li>
<li>本地主机通过网络套接字连接远程主机上的rsync daemon。命令行语法格式为上述”Access via<br>rsync daemon”段的格式。<br>前两者的本质是通过本地或远程shell，而第3种方式则是让远程主机上运行rsyncd服务，使其监听在一<br>个端口上，等待客户端的连接。<br>常见选项：</li>
</ol>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">-v：显示rsync过程中详细信息。可以使用&quot;-vvvv&quot;获取更详细信息。</span><br><span class="line">-P：显示文件传输的进度信息。(实际上&quot;-P&quot;=&quot;--partial --progress&quot;，其中的&quot;--progress&quot;才是显</span><br><span class="line">示进度信息的)。</span><br><span class="line">-n --dry-run ：仅测试传输，而不实际传输。常和&quot;-vvvv&quot;配合使用来查看rsync是如何工作的。</span><br><span class="line">-a --archive ：归档模式，表示递归传输并保持文件属性。等同于&quot;-rtopgDl&quot;。</span><br><span class="line">-r --recursive：递归到目录中去。</span><br><span class="line">-t --times：保持mtime属性。强烈建议任何时候都加上&quot;-t&quot;，否则目标文件mtime会设置为系统时间，导</span><br><span class="line">致下次更新</span><br><span class="line">：检查出mtime不同从而导致增量传输无效。</span><br><span class="line">-o --owner：保持owner属性(属主)。</span><br><span class="line">-g --group：保持group属性(属组)。</span><br><span class="line">-p --perms：保持perms属性(权限，不包括特殊权限)</span><br><span class="line">-D ：是&quot;--device --specials&quot;选项的组合，即也拷贝设备文件和特殊文件。</span><br><span class="line">-l --links：如果文件是软链接文件，则拷贝软链接本身而非软链接所指向的对象</span><br><span class="line">-z ：传输时进行压缩提高效率</span><br><span class="line">-R --relative：使用相对路径。意味着将命令行中指定的全路径而非路径最尾部的文件名发送给服务端，</span><br><span class="line">包括它们的属性。用法见下文示例。</span><br><span class="line">--size-only ：默认算法是检查文件大小和mtime不同的文件，使用此选项将只检查文件大小。</span><br><span class="line">-u --update ：仅在源mtime比目标已存在文件的mtime新时才拷贝。注意，该选项是接收端判断的，不会</span><br><span class="line">影响删除行为。</span><br><span class="line">-d --dirs ：以不递归的方式拷贝目录本身。默认递归时，如果源为&quot;dir1/file1&quot;，则不会拷贝dir1</span><br><span class="line">目录，使用该选项将拷贝dir1但不拷贝file1。</span><br><span class="line">--max-size ：限制rsync传输的最大文件大小。可以使用单位后缀，还可以是一个小数值(例如：&quot;--</span><br><span class="line">max-size=1.5m&quot;)</span><br><span class="line">--min-size ：限制rsync传输的最小文件大小。这可以用于禁止传输小文件或那些垃圾文件。</span><br><span class="line">--exclude ：指定排除规则来排除不需要传输的文件。</span><br><span class="line">--delete ：以SRC为主，对DEST进行同步。多则删之，少则补之。注意&quot;--delete&quot;是在接收端执行</span><br><span class="line">的，所以它是在</span><br><span class="line">：exclude/include规则生效之后才执行的。</span><br><span class="line">-b --backup ：对目标上已存在的文件做一个备份，备份的文件名后默认使用&quot;~&quot;做后缀。</span><br><span class="line">--backup-dir：指定备份文件的保存路径。不指定时默认和待备份文件保存在同一目录下。</span><br><span class="line">-e ：指定所要使用的远程shell程序，默认为ssh。</span><br><span class="line">--port ：连接daemon时使用的端口号，默认为873端口。</span><br><span class="line">--password-file：daemon模式时的密码文件，可以从中读取密码实现非交互式。注意，这不是远程shell</span><br><span class="line">认证的密码，而是rsync模块认证的密码。</span><br><span class="line">-W --whole-file：rsync将不再使用增量传输，而是全量传输。在网络带宽高于磁盘带宽时，该选项比增</span><br><span class="line">量传输更高效。</span><br><span class="line">--existing ：要求只更新目标端已存在的文件，目标端还不存在的文件不传输。注意，使用相对路径时如</span><br><span class="line">果上层目录不存在也不会传输。</span><br><span class="line">--ignore-existing：要求只更新目标端不存在的文件。和&quot;--existing&quot;结合使用有特殊功能，见下文示</span><br><span class="line">例。</span><br><span class="line">--remove-source-files：要求删除源端已经成功传输的文件</span><br></pre></td></tr></table></figure>

<p> 范例：两种格式访问 rsync daemon 服务 </p>
<p><img src="/../image.assets/1670396738139.png" alt="1670396738139"></p>
<ul>
<li>环境</li>
</ul>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data-server:192.168.179.171(数据服务器)</span><br><span class="line">backup-server:192.168.179.165(备份服务器)</span><br></pre></td></tr></table></figure>

<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#在备份服务器启动 rsync 进程</span><br><span class="line">[root@centos8-backup ~]#rsync --daemon</span><br><span class="line">Failed to parse config file: /etc/rsyncd.conf</span><br><span class="line">[root@centos8-backup ~]#touch /etc/rsyncd.conf</span><br><span class="line">[root@centos8-backup ~]#rsync --daemon</span><br><span class="line">[root@centos8-backup /]# cat /etc/rsyncd.conf </span><br><span class="line">[backup]</span><br><span class="line">path = /web/www/</span><br><span class="line">read only = no </span><br><span class="line">[root@centos8-backup /]# </span><br><span class="line">#指定目录给nobody权限，默认用户以nobody访问此目录</span><br><span class="line">[root@centos8-backup ~]#setfacl -m u:nobody:rwx /data/backup/</span><br><span class="line">#查看rsync服务器的模块名称</span><br><span class="line">[root@centos7-slave /]# rsync rsync://192.168.179.165</span><br><span class="line">backup    	</span><br><span class="line">[root@centos7-slave /]# </span><br><span class="line">[root@centos7-slave /]# rsync 192.168.179.165::</span><br><span class="line">backup</span><br><span class="line"></span><br><span class="line">#访问rsync服务器的共享目录</span><br><span class="line">#推</span><br><span class="line">[root@centos7-slave /]# rsync /xy.log 192.168.179.165::backup</span><br><span class="line">[root@centos7-slave /]# rsync /etc/shells rsync://root@192.168.179.165/backup</span><br><span class="line"></span><br><span class="line">[root@centos7-slave /]#rsync 192.168.179.165::backup/* /opt</span><br><span class="line">[root@centos7-slave /]#rsync rsync://192.168.179.165/backup/* /mnt</span><br></pre></td></tr></table></figure>

<p>范例：以独立服务方式运行 rsync</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"># 修改配置文件</span><br><span class="line">[root@centos8-backup etc]# cat rsyncd.conf</span><br><span class="line">#uid = root #提定以哪个用户来访问共享目录，将之指定为生成的文件所有者，默认为nobody</span><br><span class="line">#gid = root #默认为nobody,Ubuntu中为nogroup</span><br><span class="line">#port = 874 可指定非标准端口,默认873/tcp</span><br><span class="line">#use chroot = no</span><br><span class="line">#max connections = 0</span><br><span class="line">#ignore errors</span><br><span class="line">#exclude = lost+found/</span><br><span class="line">#log file = /var/log/rsyncd.log</span><br><span class="line">#pid file = /var/run/rsyncd.pid</span><br><span class="line">#lock file = /var/run/rsyncd.lock</span><br><span class="line">#reverse lookup = no</span><br><span class="line">#hosts allow = 10.0.0.0/24</span><br><span class="line">#[backup] #每个模块名对应一个不同的path目录，如果同名后面模块生效</span><br><span class="line">#path = /data/backup/</span><br><span class="line">#comment = backup dir</span><br><span class="line">#read only = no #默认是yes,即只读</span><br><span class="line">#auth users = rsyncuser #默认anonymous可以访问rsync服务器</span><br><span class="line">#secrets file = /etc/rsync.pas</span><br><span class="line"># /etc/rsyncd: configuration file for rsync daemon mode</span><br><span class="line"></span><br><span class="line"># See rsyncd.conf man page for more options.</span><br><span class="line"></span><br><span class="line"># configuration example:</span><br><span class="line"></span><br><span class="line"># uid = nobody</span><br><span class="line"># gid = nobody</span><br><span class="line"># use chroot = yes</span><br><span class="line"># max connections = 4</span><br><span class="line"># pid file = /var/run/rsyncd.pid</span><br><span class="line"># exclude = lost+found/</span><br><span class="line"># transfer logging = yes</span><br><span class="line"># timeout = 900</span><br><span class="line"># ignore nonreadable = yes</span><br><span class="line"># dont compress   = *.gz *.tgz *.zip *.z *.Z *.rpm *.deb *.bz2</span><br><span class="line"></span><br><span class="line"># [ftp]</span><br><span class="line">#        path = /home/ftp</span><br><span class="line">#        comment = ftp export area</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">uid = root </span><br><span class="line">gid = root  </span><br><span class="line">max connections = 0</span><br><span class="line">ignore errors</span><br><span class="line">exclude = lost+found/</span><br><span class="line">log file = /var/log/rsyncd.log</span><br><span class="line">pid file = /var/run/rsyncd.pid</span><br><span class="line">lock file = /var/run/rsyncd.lock</span><br><span class="line">reverse lookup = no</span><br><span class="line"></span><br><span class="line">[backup] </span><br><span class="line">path = /web/backup/  </span><br><span class="line">comment = backup dir</span><br><span class="line">read only = no </span><br><span class="line">auth users = rsyncuser  </span><br><span class="line">secrets file = /etc/rsync.pas</span><br><span class="line"></span><br><span class="line">[root@centos8-backup etc]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#服务器端生成验证文件</span><br><span class="line">[root@centos8-backup ~]#echo &quot;rsyncuser:123456&quot; &gt; /etc/rsync.pas</span><br><span class="line">[root@centos8-backup ~]#chmod 600 /etc/rsync.pas</span><br><span class="line"></span><br><span class="line">#服务器端启动rsync服务</span><br><span class="line">[root@centos8-backup ~]#rsync --daemon #可加入/etc/rc.d/rc.local实现开</span><br><span class="line">机启动</span><br><span class="line"></span><br><span class="line">#客户端配置密码文件</span><br><span class="line">#也可将密码赋值给环境变量RSYNC_PASSWORD变量,但不安全</span><br><span class="line">#export RSYNC_PASSWORD=123456</span><br><span class="line">[root@centos7-slave ~]#echo &quot;123456&quot; &gt; /etc/rsync.pas</span><br><span class="line">[root@centos7-slave ~]#chmod 600 /etc/rsync.pas #此为必要项,权限必须修改</span><br><span class="line"></span><br><span class="line">#查看远程rsync服务器的模块信息</span><br><span class="line">[root@centos7-slave etc]# rsync rsync://192.168.179.165</span><br><span class="line">backup         	backup dir</span><br><span class="line">[root@centos7-slave etc]# </span><br><span class="line"></span><br><span class="line">#交互式验证查看具体模块内的文件</span><br><span class="line">[root@centos7-slave etc]# rsync rsync://rsyncuser@192.168.179.165/backup</span><br><span class="line">Password: </span><br><span class="line"></span><br><span class="line">#非交互式查看共享目录</span><br><span class="line">[root@centos7-slave etc]# rsync --password-file=/etc/rsync.pas rsync://rsyncuser@192.168.179.165/backup</span><br><span class="line">drwxrwxrwx             34 2022/12/07 16:20:07 .</span><br><span class="line">-rw-r--r--              0 2022/12/07 16:20:07 xy.log</span><br><span class="line">-rw-r--r--              0 2022/12/07 16:09:50 zz.log</span><br><span class="line">[root@centos7-slave etc]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#客户端测试同步数据</span><br><span class="line">[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas /data/www/ rsyncuser@rsync服务器IP::backup</span><br><span class="line">[root@data-centos8 ~]#rsync -avz --delete --password-file=/etc/rsync.pas rsyncuser@rsync服务器IP::backup /data/www/</span><br></pre></td></tr></table></figure>

<h3 id="inotify-rsync-shell-脚本实现实时数据同步"><a href="#inotify-rsync-shell-脚本实现实时数据同步" class="headerlink" title="inotify+rsync+shell 脚本实现实时数据同步"></a>inotify+rsync+shell 脚本实现实时数据同步</h3><p><img src="/../image.assets/1670403695085.png" alt="1670403695085"></p>
<p>按 5.3 搭建好 rsyncd的备份服务器，在数据服务器上创建inotify_rsync.sh脚本<br>注意: 此脚本执行前先确保两主机初始数据处于同步状态,此脚本实现后续的数据同步</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7-slave ~]# vim inotify_rsync.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">SRC=&#x27;/data/www/&#x27; #注意最后的/</span><br><span class="line">DEST=&#x27;rsyncuser@rsync服务器IP::backup&#x27;</span><br><span class="line">rpm -q inotify-tools &amp;&gt; /dev/null ||yum -y install inotify-tools</span><br><span class="line">rpm -q rsync &amp;&gt; /dev/null || yum -y install rsync</span><br><span class="line">inotifywait -mrq --exclude=&quot;.*\.swp&quot; --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format</span><br><span class="line">&#x27;%T %w %f&#x27; -e create,delete,moved_to,close_write,attrib $&#123;SRC&#125; |while read DATE</span><br><span class="line">TIME DIR FILE;do</span><br><span class="line">FILEPATH=$&#123;DIR&#125;$&#123;FILE&#125;</span><br><span class="line">rsync -az --delete --password-file=/etc/rsync.pas $SRC $DEST &amp;&amp; echo</span><br><span class="line">&quot;At $&#123;TIME&#125; on $&#123;DATE&#125;, file $FILEPATH was backuped up via rsync&quot; &gt;&gt;</span><br><span class="line">/var/log/changelist.log</span><br><span class="line">done</span><br><span class="line">#查看文件传输日志</span><br><span class="line">[root@centos7-slave www]# tail -f /var/log/changelist.log </span><br></pre></td></tr></table></figure>

<h2 id="sersync-实现实时数据同步"><a href="#sersync-实现实时数据同步" class="headerlink" title="sersync 实现实时数据同步"></a>sersync 实现实时数据同步</h2><h3 id="sersync-介绍"><a href="#sersync-介绍" class="headerlink" title="sersync 介绍"></a>sersync 介绍</h3><p>sersync类似于inotify，同样用于监控，但它克服了inotify的缺点.<br>inotify最大的不足是会产生重复事件，或者同一个目录下多个文件的操作会产生多个事件，例如，当监<br>控目录中有5个文件时，删除目录时会产生6个监控事件，从而导致重复调用rsync命令。另外比如：vim<br>文件时，inotify会监控到临时文件的事件，但这些事件相对于rsync来说是不应该被监控的</p>
<p><strong>sersync 优点：</strong></p>
<ul>
<li>sersync是使用c++编写，而且对linux系统文件系统产生的临时文件和重复的文件操作进行过滤，<br>所以在结合rsync同步的时候，节省了运行时耗和网络资源。因此更快。</li>
<li>sersync配置很简单，其中提供了静态编译好的二进制文件和xml配置文件，直接使用即可</li>
<li>sersync使用多线程进行同步，尤其在同步较大文件时，能够保证多个服务器实时保持同步状态</li>
<li>sersync有出错处理机制，通过失败队列对出错的文件重新同步，如果仍旧失败，则按设定时长对<br>同步失败的文件重新同步</li>
<li>sersync不仅可以实现实时同步，另外还自带crontab功能，只需在xml配置文件中开启，即也可以<br>按要求隔一段时间整体同步一次，而无需再额外配置crontab功能</li>
<li>sersync 可以二次开发</li>
</ul>
<p>sersync项目地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/">https://code.google.com/archive/p/sersync/</a><br>sersync下载地址： <a target="_blank" rel="noopener" href="https://code.google.com/archive/p/sersync/downloads">https://code.google.com/archive/p/sersync/downloads</a></p>
<h3 id="基于rsync-daemon-实现-sersync"><a href="#基于rsync-daemon-实现-sersync" class="headerlink" title="基于rsync daemon 实现 sersync"></a>基于rsync daemon 实现 sersync</h3><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"># #在数据服务器上下载sersync，并拷贝至相应的目录，设置PATH变量</span><br><span class="line">wget https://storage.googleapis.com/google-code-archive-downloads/v2/code.google.com/sersync/sersync2.5.4_64bit_binary_stable_final.tar.gz</span><br><span class="line"></span><br><span class="line">[root@centos7-slave ~]# tar -vxf sersync2.5.4_64bit_binary_stable_final.tar.gz </span><br><span class="line">[root@centos7-slave ~]# cp -r GNU-Linux-x86/ /usr/local/sersync</span><br><span class="line">[root@centos7-slave sersync]# echo &#x27;PATH=/usr/local/sersync:$PATH&#x27; &gt; /etc/profile.d/sersync.sh</span><br><span class="line">[root@centos7-slave sersync]# source /etc/profile.d/sersync.sh</span><br><span class="line">[root@centos7-slave sersync]# </span><br><span class="line"></span><br><span class="line">#确认安装rsync客户端工具</span><br><span class="line">rpm -q rsync &amp;&gt; /dev/null || dnf -y install rsync</span><br><span class="line"></span><br><span class="line">#备份sersync配置文件</span><br><span class="line">cp /usr/local/sersync/confxml.xml&#123;,.bak&#125;</span><br><span class="line"># 修改配置文件</span><br><span class="line">vim /usr/local/sersync/confxml.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;ISO-8859-1&quot;?&gt;</span><br><span class="line">&lt;head version=&quot;2.5&quot;&gt;</span><br><span class="line">&lt;host hostip=&quot;localhost&quot; port=&quot;8008&quot;&gt;&lt;/host&gt;</span><br><span class="line">&lt;debug start=&quot;false&quot;/&gt; # 是否开启调试模式</span><br><span class="line">&lt;fileSystem xfs=&quot;false&quot;/&gt;</span><br><span class="line">&lt;filter start=&quot;false&quot;&gt; #不开启文件过滤功能，当为true时,以下类型的文件将不同</span><br><span class="line">步</span><br><span class="line">&lt;exclude expression=&quot;(.*)\.svn&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;exclude expression=&quot;(.*)\.gz&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;exclude expression=&quot;^info/*&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;exclude expression=&quot;^static/*&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line">&lt;inotify&gt; # 监控事件，默认监控</span><br><span class="line">delete/close_write/moved_from/moved_to/create folder</span><br><span class="line">&lt;delete start=&quot;true&quot;/&gt;</span><br><span class="line">&lt;createFolder start=&quot;true&quot;/&gt;</span><br><span class="line">&lt;createFile start=&quot;false&quot;/&gt;</span><br><span class="line">&lt;closeWrite start=&quot;true&quot;/&gt;</span><br><span class="line">&lt;moveFrom start=&quot;true&quot;/&gt;</span><br><span class="line">&lt;moveTo start=&quot;true&quot;/&gt;</span><br><span class="line">&lt;attrib start=&quot;true&quot;/&gt; #修改此行为true，文件属性变化后也会同步</span><br><span class="line">&lt;modify start=&quot;false&quot;/&gt;</span><br><span class="line">&lt;/inotify&gt;</span><br><span class="line">&lt;sersync&gt; # rsync命令的配置段</span><br><span class="line">&lt;localpath watch=&quot;/data/www&quot;&gt; #修改此行,需要同步的源目录或文件，建议同步目</span><br><span class="line">录</span><br><span class="line">&lt;remote ip=&quot;备份服务器IP&quot; name=&quot;backup&quot;/&gt; #修改此行,指定备份服务器地址和rsync</span><br><span class="line">daemon的模块名，如果下面开启了ssh start，此时name为远程shell方式运行时的目标目录</span><br><span class="line">&lt;!--&lt;remote ip=&quot;192.168.8.39&quot; name=&quot;tongbu&quot;/&gt;--&gt;</span><br><span class="line">&lt;!--&lt;remote ip=&quot;192.168.8.40&quot; name=&quot;tongbu&quot;/&gt;--&gt;</span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">&lt;rsync&gt;</span><br><span class="line">&lt;commonParams params=&quot;-artuz&quot;/&gt; # 指定rsync选项</span><br><span class="line">&lt;auth start=&quot;true&quot; users=&quot;rsyncuser&quot; passwordfile=&quot;/etc/rsync.pas&quot;/&gt; #修</span><br><span class="line">改此行为true,指定备份服务器的rsync配置的用户和密码文件</span><br><span class="line">&lt;userDefinedPort start=&quot;false&quot; port=&quot;874&quot;/&gt;&lt;!-- port=874 --&gt;#指定rsync的非</span><br><span class="line">标准端口号</span><br><span class="line">&lt;timeout start=&quot;false&quot; time=&quot;100&quot;/&gt;&lt;!-- timeout=100 --&gt;</span><br><span class="line">&lt;ssh start=&quot;false&quot;/&gt; #默认使用rsync daemon运行rsync命令,true为使用远程shell模</span><br><span class="line">式</span><br><span class="line">&lt;/rsync&gt;</span><br><span class="line">&lt;failLog path=&quot;/tmp/rsync_fail_log.sh&quot; timeToExecute=&quot;60&quot;/&gt;&lt;!--default every</span><br><span class="line">60mins execute once--&gt; #错误重传及日志文件路径</span><br><span class="line">&lt;crontab start=&quot;false&quot; schedule=&quot;600&quot;&gt;&lt;!--600mins--&gt; #不开启crontab功能</span><br><span class="line">&lt;crontabfilter start=&quot;false&quot;&gt; #不开启crontab定时传输的筛选功能</span><br><span class="line">&lt;exclude expression=&quot;*.php&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;exclude expression=&quot;info/*&quot;&gt;&lt;/exclude&gt;</span><br><span class="line">&lt;/crontabfilter&gt;</span><br><span class="line">&lt;/crontab&gt;</span><br><span class="line">&lt;plugin start=&quot;false&quot; name=&quot;command&quot;/&gt;</span><br><span class="line">&lt;/sersync&gt;</span><br><span class="line">#####################################以下行不需要修改</span><br><span class="line">####################################</span><br><span class="line">&lt;plugin name=&quot;command&quot;&gt;</span><br><span class="line">&lt;param prefix=&quot;/bin/sh&quot; suffix=&quot;&quot; ignoreError=&quot;true&quot;/&gt; &lt;!--prefix</span><br><span class="line">/opt/tongbu/mmm.sh suffix--&gt;</span><br><span class="line">&lt;filter start=&quot;false&quot;&gt;</span><br><span class="line">&lt;include expression=&quot;(.*)\.php&quot;/&gt;</span><br><span class="line">&lt;include expression=&quot;(.*)\.sh&quot;/&gt;</span><br><span class="line">&lt;/filter&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line">&lt;plugin name=&quot;socket&quot;&gt;</span><br><span class="line">&lt;localpath watch=&quot;/opt/tongbu&quot;&gt;</span><br><span class="line">&lt;deshost ip=&quot;192.168.138.20&quot; port=&quot;8009&quot;/&gt;</span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line">&lt;plugin name=&quot;refreshCDN&quot;&gt;</span><br><span class="line">&lt;localpath watch=&quot;/data0/htdocs/cms.xoyo.com/site/&quot;&gt;</span><br><span class="line">&lt;cdninfo domainname=&quot;ccms.chinacache.com&quot; port=&quot;80&quot; username=&quot;xxxx&quot;</span><br><span class="line">passwd=&quot;xxxx&quot;/&gt;</span><br><span class="line">&lt;sendurl base=&quot;http://pic.xoyo.com/cms&quot;/&gt;</span><br><span class="line"> &lt;regexurl regex=&quot;false&quot; match=&quot;cms.xoyo.com/site([/a-zA-Z0-</span><br><span class="line">9]*).xoyo.com/images&quot;/&gt;</span><br><span class="line">&lt;/localpath&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#创建连接rsynd服务器的用户密码文件,并必须修改权限</span><br><span class="line">echo 123456 &gt; /etc/rsync.pas</span><br><span class="line">chmod 600 /etc/rsync.pas</span><br><span class="line">#查看帮助</span><br><span class="line">sersync2 -h</span><br><span class="line">set the system param</span><br><span class="line">execute：echo 50000000 &gt; /proc/sys/fs/inotify/max_user_watches</span><br><span class="line">execute：echo 327679 &gt; /proc/sys/fs/inotify/max_queued_events</span><br><span class="line">parse the command param</span><br><span class="line"></span><br><span class="line">_______________________________________________________</span><br><span class="line">参数-d:启用守护进程模式</span><br><span class="line">参数-r:在监控前，将监控目录与远程主机用rsync命令推送一遍</span><br><span class="line">c参数-n: 指定开启守护线程的数量，默认为10个</span><br><span class="line">参数-o:指定配置文件，默认使用当前工作目录下的confxml.xml文件</span><br><span class="line">参数-m:单独启用其他模块，使用 -m refreshCDN 开启刷新CDN模块</span><br><span class="line">参数-m:单独启用其他模块，使用 -m socket 开启socket模块</span><br><span class="line">参数-m:单独启用其他模块，使用 -m http 开启http模块</span><br><span class="line">不加-m参数，则默认执行同步程序</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#以后台方式执行同步</span><br><span class="line">sersync2 -dro /usr/local/sersync/confxml.xml</span><br><span class="line"></span><br><span class="line">#如果同步失败,可以手动执行下面命令,观察过程</span><br><span class="line">cd /data/www &amp;&amp; rsync -artuz -R --delete ./ rsyncuser@backup-server::backup --password-file=/etc/rsync.pas &gt;/dev/null 2&gt;&amp;1</span><br><span class="line"></span><br><span class="line">#sersync支持多实例，也即监控多个目录时，只需分别配置不同配置文件，然后使用sersync2指定对应配置文件运行</span><br><span class="line">sersync2 -rd -o /etc/sersync.d/nginx.xml</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">首页</a></li>
         
          <li><a href="/archives/">归档</a></li>
         
          <li><a href="/tags/">标签</a></li>
         
          <li><a href="/categories/">分类</a></li>
         
          <li><a href="/search/">搜索</a></li>
         
          <li><a href="/about/">关于</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#NFS%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.</span> <span class="toc-text">NFS服务</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.</span> <span class="toc-text">NFS工作原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E8%BD%AF%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.</span> <span class="toc-text">NFS软件介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NFS%E5%B7%A5%E5%85%B7"><span class="toc-number">1.3.</span> <span class="toc-text">NFS工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rpcinfo"><span class="toc-number">1.3.1.</span> <span class="toc-text">rpcinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exportfs"><span class="toc-number">1.3.2.</span> <span class="toc-text">exportfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#showmount"><span class="toc-number">1.3.3.</span> <span class="toc-text">showmount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mount-nfs"><span class="toc-number">1.3.4.</span> <span class="toc-text">mount.nfs</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AE%9E%E6%88%98%E6%A1%88%E4%BE%8B"><span class="toc-number">2.</span> <span class="toc-text">实战案例</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%9A%84%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5"><span class="toc-number">3.</span> <span class="toc-text">数据的实时同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E5%90%8C%E6%AD%A5%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.0.1.</span> <span class="toc-text">实时同步技术介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-inotify"><span class="toc-number">3.0.2.</span> <span class="toc-text">实现 inotify</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#inotify-tools%E5%B7%A5%E5%85%B7"><span class="toc-number">3.0.2.1.</span> <span class="toc-text">inotify-tools工具</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rsync-%E6%9C%8D%E5%8A%A1"><span class="toc-number">3.1.</span> <span class="toc-text">rsync 服务</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#rsync%E5%91%BD%E4%BB%A4"><span class="toc-number">3.1.0.1.</span> <span class="toc-text">rsync命令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inotify-rsync-shell-%E8%84%9A%E6%9C%AC%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">3.1.1.</span> <span class="toc-text">inotify+rsync+shell 脚本实现实时数据同步</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#sersync-%E5%AE%9E%E7%8E%B0%E5%AE%9E%E6%97%B6%E6%95%B0%E6%8D%AE%E5%90%8C%E6%AD%A5"><span class="toc-number">3.2.</span> <span class="toc-text">sersync 实现实时数据同步</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#sersync-%E4%BB%8B%E7%BB%8D"><span class="toc-number">3.2.1.</span> <span class="toc-text">sersync 介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ersync-daemon-%E5%AE%9E%E7%8E%B0-sersync"><span class="toc-number">3.2.2.</span> <span class="toc-text">基于rsync daemon 实现 sersync</span></a></li></ol></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&text=网络文件共享服务"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&is_video=false&description=网络文件共享服务"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=网络文件共享服务&body=Check out this article: http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&title=网络文件共享服务"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&name=网络文件共享服务&description=Network File System 网络文件系统，基于内核的文件系统。Sun 公司开发，通过使用 NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://news.ycombinator.com/submitlink?u=http://cactus.itshare.work/2022/12/04/%E7%BD%91%E7%BB%9C%E6%96%87%E4%BB%B6%E5%85%B1%E4%BA%AB%E6%9C%8D%E5%8A%A1/&t=网络文件共享服务"><i class="fab fa-hacker-news fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> 菜单</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> 目录</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> 分享</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> 返回顶部</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy;
    
    
    2022-2023
    yuan kun
  </div>
  <div class="footer-right">
    <nav>
      <ul>
        <!--
       --><li><a href="/">首页</a></li><!--
     --><!--
       --><li><a href="/archives/">归档</a></li><!--
     --><!--
       --><li><a href="/tags/">标签</a></li><!--
     --><!--
       --><li><a href="/categories/">分类</a></li><!--
     --><!--
       --><li><a href="/search/">搜索</a></li><!--
     --><!--
       --><li><a href="/about/">关于</a></li><!--
     -->
      </ul>
    </nav>
<!--<p class="size-small">
    <a href="http://www.beian.miit.gov.cn" target="_blank" rel="noopener">黔ICP备2022006994号</a>
  </p>-->
  </div>
</footer>

    </div>
    <!-- styles -->



  <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.2/css/all.min.css" crossorigin="anonymous" onload="this.onload=null;this.rel='stylesheet'"/>


    <!-- jquery -->
 
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" crossorigin="anonymous"></script> 




<!-- clipboard -->

  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.7/clipboard.min.js" crossorigin="anonymous"></script> 
  
  <script type="text/javascript">
  $(function() {
    // copy-btn HTML
    var btn = "<span class=\"btn-copy tooltipped tooltipped-sw\" aria-label=\"复制到粘贴板！\">";
    btn += '<i class="far fa-clone"></i>';
    btn += '</span>'; 
    // mount it!
    $(".highlight table").before(btn);
    var clip = new ClipboardJS('.btn-copy', {
      text: function(trigger) {
        return Array.from(trigger.nextElementSibling.querySelectorAll('.code')).reduce((str,it)=>str+it.innerText+'\n','')
      }
    });
    clip.on('success', function(e) {
      e.trigger.setAttribute('aria-label', "复制成功！");
      e.clearSelection();
    })
  })
  </script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Cloudflare Analytics -->

<!-- Umami Analytics -->

<!-- Disqus Comments -->

<!-- utterances Comments -->

</body>
</html>
